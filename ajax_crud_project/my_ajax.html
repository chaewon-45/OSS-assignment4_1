<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AJAX CRUD 실습</title>
</head>
<body>
  <h2>학생 데이터 관리</h2>

  <button id="btnStu">학생데이터 가져오기</button><br><br>
  <input id="name" placeholder="name">
  <input id="age" placeholder="age">
  <button id="btnAdd">학생데이터 추가</button>

  <div id="contents"></div>

  <script>
    window.onload = function() {
      let btnStu = document.getElementById("btnStu");
      let btnAdd = document.getElementById("btnAdd");

      btnStu.addEventListener("click", getStudents);
      btnAdd.addEventListener("click", postData);
    }

    function getStudents() {
      let contents = document.getElementById("contents");
      const xhr = new XMLHttpRequest();
      xhr.open("GET", "http://localhost:3001/students");
      xhr.setRequestHeader("content-type", "application/json");
      xhr.send();

      xhr.onload = () => {
        if (xhr.status === 200) {
          const res = JSON.parse(xhr.response);
          contents.innerHTML = makeList(res);
        } else {
          console.log(xhr.status, xhr.statusText);
        }
      }
    }

    function makeList(data) {
        let str = "<ul>";
        for (let key in data) {
            str += `
            <li>
                ${data[key].name} (${data[key].age})
                <button onclick="updateData(${data[key].id})">수정</button>
                <button onclick="deleteData(${data[key].id})">삭제</button>
            </li>
            `;
        }
        str += "</ul>";
        return str;
    }


    function postData() {
      let name = document.getElementById("name");
      let age = document.getElementById("age");

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "http://localhost:3001/students");
      xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
      const data = { name: name.value, age: age.value };
      xhr.send(JSON.stringify(data));

      xhr.onload = () => {
        if (xhr.status === 201) {
          name.value = "";
          age.value = "";
          getStudents();
        } else {
          console.log(xhr.status, xhr.statusText);
        }
      }
    }

    function updateData(id) {
      const xhr = new XMLHttpRequest();
      xhr.open("PUT", "http://localhost:3001/students/" + id);
      xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");

      const name = prompt("새 이름을 입력하세요:");
      const age = prompt("새 나이를 입력하세요:");

      if (!name || !age) return;

      const data = { name: name, age: parseInt(age) };
      xhr.send(JSON.stringify(data));

      xhr.onload = () => {
        if (xhr.status === 200) {
          console.log("수정 완료:", JSON.parse(xhr.response));
          getStudents();
        } else {
          console.log(xhr.status, xhr.statusText);
        }
      }
  }



    // 데이터 삭제 (DELETE)
    function deleteData(id) {
      const xhr = new XMLHttpRequest();
      xhr.open("DELETE", "http://localhost:3001/students/" + id);
      xhr.send();

      xhr.onload = () => {
        if (xhr.status === 200) {
          console.log("삭제 완료:", id);
          getStudents();
        } else {
          console.log(xhr.status, xhr.statusText);
        }
      }
    }

  </script>
</body>
</html>
